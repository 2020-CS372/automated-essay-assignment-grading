figure 3.
  If there is a switch  inserted between the time reference and the time client, a  time variant variable is involved.  T=(1+α)t +β + p(t)                                      (1) Where p(t) is a random delay function including the  switching delay, queue delay and so on.  Without the p(t)α and β can be calculated by statistical, filtering and erasure  methods, but with p(t) it is difficult to do so.  B. Time Synchronization Model Traditional CNC systems based on fieldbus usually  synchronize serve controllers, PLC and other devices with  the MCU. But in the CNC system, there are a switch  between such devices and the MCU, so if we also use the  MCU as the time reference, it will really hard to achieve T5  requirement because the delay p(t) in the switch is time  variant.  So we proposed synchronizes the MCU and other  nodes with the switch, because the switch is also an  intelligentized system with clock and its position is the center  in the star topology as shown in figure 2. More important is  that every node has an exclusive full-duplex link with the  switch and the data exchange between the node and switch  will not suffer from collisions at all.   MCU SWITCH PLC/IO Master Clock Slave Servo Controller MOTOR Slave Servo Controller MOTOR ... ... Figure 2. Time Synchronization based on the switch clock The proposed synchronization method between the  switch and other devices in the CNC system synchronizes  the slave clock to the master clock by periodically  exchanging synchronization frames like SNTP. As we  known the SNTP can’t achieve class T5 requirements, so  some enhancements must be performed. Firstly, let’s analyze the time stamp and its delay. Figure 3 Time Synchronization Frame Delay285 The delay from the time stamping of a time  synchronization message of SNTP in switch until it is time  stamped in the message destination device can be shown as   figure 3. Every time client and the time reference are connected  directly, so the network traversal delay can be treated as a  constant which is decided by the length of the network cable.  Variations in the delays are due to OS scheduling  unpredictability and network access unpredictability.  To  reduce the variations in the delay and to attain sufficient  time-stamping accuracy, a low-level time-stamping scheme  must be implemented both in the switch and other devices.   There are three low-level time-stamping methods: 1) Time stamping in (or close to) the Ethernet controller 2) Time stamping in the interrupt service routine(ISR)  outside the RTOS 3) Time stamping in the Ethernet driver controlled by  the RTOS     To achieve class T5, we adopt the hardware time stamping  in the Ethernet controller as shown in Figure 4. 802.  Time Client 802.3 Hardware Timestamp MAC ... Figure 4  Time synchronization scheme The process of time synchronization can be described  below. The time client initiates a time synchronization  request at time t0, the frame contains a time t1 where t1 > t0  and t1 is bigger enough than the maximum delay to transmit  a message.  The time synchronization request wouldn’t be  sent until actual time is equal to t1 given in the request frame  payload.  As soon as the time request frame enters the switch,  it is time stamped in the hardware named t2. 

